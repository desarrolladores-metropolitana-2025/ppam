<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Planificación</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; margin:0; padding:0; }

.container { max-width:1200px; margin:15px auto; padding:0 15px; }
h1 { margin-bottom:15px; color:#333; }
.week-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.btn-week { padding:4px 8px; font-size:13px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; }
.btn-week:hover { background:#0056b3; }
.tabs { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
.tab { padding:8px 12px; background:#007bff; color:white; border-radius:6px; cursor:pointer; font-size:14px; }
.tab.active { background:#0056b3; }
.card { border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:15px; margin-bottom:10px; background:white; }
.dia-header { cursor:pointer; background:#e2e6ea; padding:8px; border-radius:6px; margin-bottom:5px; display:flex; align-items:center; font-weight:600; gap:8px; }
.dia-header .toggle-arrow { margin-right:6px; }
.dia-header .fecha { margin-right:8px; }
.dia-header input[type="checkbox"] { margin-left:auto; transform:scale(1.1); cursor:pointer; }
.dia-content { margin-bottom:10px; }
table { width:100%; border-collapse:collapse; margin-top:5px; }
th, td { padding:6px; border:1px solid #ddd; text-align:left; font-size:13px; white-space:nowrap; }
th { background:#343a40; color:white; }
tr:nth-child(even) td { background:transparent; } /* keep stripes neutral, use row class for color */
.action-buttons { display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
.btn-publicar { background:#28a745; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }
.btn-publicar:hover { background:#218838; }
.btn-privar { background:#6c757d; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }
.btn-privar:hover { background:#5a6268; }

/* Row colors: cada fila según t.is_public */
tr.turno-publico td { background-color: #d4edda !important; } /* verde claro */
tr.turno-borrador td { background-color: #cce5ff !important; } /* celeste */
.tag-turnos { color: #555; font-size: 11px; }
.tag-principiante { background: #ffdd57; padding: 2px 4px; font-size: 11px; border-radius: 3px; }
.tag-alerta { color: #b22222; font-weight: bold; font-size: 11px; }
.check-master { transform:scale(1.05); cursor:pointer; }
@media (max-width:768px){ .tabs{flex-direction:column;} table, th, td{font-size:12px;} }
</style>
</head>
<body>
    <div class="container py-4">
    <!-- Navbar -->
    {% include 'nav_bar.html' %}


    <h1>Planificación</h1>


<!-- Mensajes de creación, edición, etc -->
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
    {% endwith %}


    <div class="week-nav">
        <a href="{{ url_for('planificacion_index', week_start=prev_week.strftime('%Y-%m-%d')) }}" class="btn-week">⬅ Semana anterior</a>
        <span>Semana del {{ week_start.strftime('%d-%m-%Y') }} al {{ week_end.strftime('%d-%m-%Y') }}</span>
        <a href="{{ url_for('planificacion_index', week_start=next_week.strftime('%Y-%m-%d')) }}" class="btn-week">Semana siguiente ➡</a>
    </div>

    <div class="tabs">
        {% for punto in puntos %}
        <div class="tab {% if loop.first %}active{% endif %}" onclick="showTab({{ loop.index0 }})">
            {{ punto.punto_nombre }}
        </div>
        {% endfor %}
    </div>

    {% for punto in puntos %}
    <div class="card punto-card" data-punto="{{ punto.id }}" style="{% if not loop.first %}display:none{% endif %}">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
            <h2 style="margin:0;">{{ punto.punto_nombre }}</h2>
			<span>  ⛔ : inactivo / <span style="color:#28a745; font-weight:bold;">⭐</span> : Principiante</span>
            <!-- checkbox maestro del punto (toda la semana) -->
            <label style="margin-left:auto; display:flex; align-items:center; gap:6px; font-weight:600;">
                <input type="checkbox" class="check-semana check-master" data-punto="{{ punto.id }}" title="Seleccionar todos los turnos de este punto (toda la semana)">
                <span style="font-size:13px; color:#333;">Seleccionar semana</span>
            </label>
        </div>
        <!-- Dentro de cada .punto-card (por ejemplo arriba del form o debajo): -->
		<div class="planificacion-stats" style="margin-bottom:10px; font-size:14px;">
			<strong>Estadísticas:</strong>
			<span class="stat-publicos">Publicos: <em>—</em></span>
			<span style="margin-left:8px;" class="stat-borradores">Borradores: <em>—</em></span>
			<span style="margin-left:8px;" class="stat-dias">Días completos: <em>—</em></span>
		</div>
        <form id="form_planificacion_{{ punto.id }}" action="{{ url_for('planificacion_actualizar') }}" method="POST">
            <input type="hidden" name="punto_id" value="{{ punto.id }}">
            <input type="hidden" name="week_start" value="{{ week_start.strftime('%Y-%m-%d') }}">

            <div class="action-buttons">
                <button type="submit" name="accion" value="publicar" class="btn-publicar">Hacer públicos los seleccionados</button>
                <button type="submit" name="accion" value="privado" class="btn-privar">Pasar a borrador los seleccionados</button>
            </div>

            {% for dia, turnos_dia in turnos[punto.id].items() %}
<div class="dia-section">
    <div class="dia-header" data-dia="{{ dia }}">
        <span class="toggle-arrow">▼</span>
        <span class="fecha">
            {{ dia.capitalize() }} – 
            {% if turnos_dia %}
                {{ turnos_dia[0]['fecha'].strftime('%d-%m-%Y') }}
            {% else %}
                Sin turnos
            {% endif %}
        </span>
        <input type="checkbox" class="check-dia check-master" data-punto="{{ punto.id }}" data-dia="{{ dia }}" title="Seleccionar todos los turnos del día" onclick="event.stopPropagation()">
    </div>

    <div class="dia-content">
        <table>
            <thead>
                <tr>
                    <th style="width:40px;"></th>
                    <th>Hora Inicio</th>
                    <th>Hora Fin</th>
                    <th>Capitán</th>
                    <th>Publicador 1</th>
                    <th>Publicador 2</th>
                    <th>Publicador 3</th>
                    <th>Publicador 4</th>
                </tr>
            </thead>
            <tbody>
                {% if turnos_dia %}
                    {% for t in turnos_dia %}
                    <tr class="turno-{{ 'publico' if t.is_public else 'borrador' }}">
                        <td style="text-align:center;">
                            <input type="checkbox" class="turno-checkbox" data-punto="{{ punto.id }}" data-dia="{{ dia }}" name="turno_ids" value="{{ t['id'] }}">
                        </td>
                        <td>{{ t['hora_inicio'].strftime('%H:%M') if t['hora_inicio'] else '-' }}</td>
                        <td>{{ t['hora_fin'].strftime('%H:%M') if t['hora_fin'] else '-' }}</td>
                        <td>
    {% set pid = t.capitan_id %}
    {% if pid %}
        {{ pub_map[pid] }}
        <span style="color:#007bff;">({{ pub_info[pid].turnos_semana }} t)</span>

        {% if pub_info[pid].principiante %}
            <span style="color:#28a745; font-weight:bold;">⭐</span>
        {% endif %}

        {% if pub_info[pid].inactivo %}
            <span style="color:#c0392b; font-weight:bold;" title="Hace {{ pub_info[pid].dias_inactivo }} días que no participa.">⛔</span>
        {% endif %}
    {% else %}
        -
    {% endif %}
</td>

                       <td>
    {% set pid = t['publicador1_id'] %}
    {% if pid %}
        {{ pub_map[pid] }}
        <span style="color:#007bff;">({{ pub_info[pid].turnos_semana }} t)</span>

        {% if pub_info[pid].principiante %}
            <span style="color:#28a745; font-weight:bold;">⭐</span>
        {% endif %}

        {% if pub_info[pid].inactivo %}
            <span style="color:#c0392b; font-weight:bold;" title="Hace {{ pub_info[pid].dias_inactivo }} días que no participa.">⛔</span>
        {% endif %}
    {% else %}
        -
    {% endif %}
</td>


                        <td>
    {% set pid = t['publicador2_id'] %}
    {% if pid %}
        {{ pub_map[pid] }}
        <span style="color:#007bff;">({{ pub_info[pid].turnos_semana }} t)</span>

        {% if pub_info[pid].principiante %}
            <span style="color:#28a745; font-weight:bold;">⭐</span>
        {% endif %}

        {% if pub_info[pid].inactivo %}
            <span style="color:#c0392b; font-weight:bold;" title="Hace {{ pub_info[pid].dias_inactivo }} días que no participa.">⛔</span>
        {% endif %}
    {% else %}
        -
    {% endif %}
</td>

                         <td>
    {% set pid = t['publicador3_id'] %}
    {% if pid %}
        {{ pub_map[pid] }}
        <span style="color:#007bff;">({{ pub_info[pid].turnos_semana }} t)</span>

        {% if pub_info[pid].principiante %}
            <span style="color:#28a745; font-weight:bold;">⭐</span>
        {% endif %}

        {% if pub_info[pid].inactivo %}
            <span style="color:#c0392b; font-weight:bold;" title="Hace {{ pub_info[pid].dias_inactivo }} días que no participa.">⛔</span>
        {% endif %}
    {% else %}
        -
    {% endif %}
</td>

                         <td>
    {% set pid = t['publicador4_id'] %}
    {% if pid %}
        {{ pub_map[pid] }}
        <span style="color:#007bff;">({{ pub_info[pid].turnos_semana }} t)</span>

        {% if pub_info[pid].principiante %}
            <span style="color:#28a745; font-weight:bold;">⭐</span>
        {% endif %}

        {% if pub_info[pid].inactivo %}
            <span style="color:#c0392b; font-weight:bold;" title="Hace {{ pub_info[pid].dias_inactivo }} días que no participa.">⛔</span>
        {% endif %}
    {% else %}
        -
    {% endif %}
		</td>

                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" style="text-align:center; font-style:italic;">No hay turnos programados.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endfor %}
        </form>
		

    </div>
    {% endfor %}
</div>
<script src="{{ url_for('static', filename='js/planificacion.js') }}"></script>
</body>
</html>
