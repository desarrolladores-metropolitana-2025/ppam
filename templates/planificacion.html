<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Planificación</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f2f5; margin:0; padding:0; }

.container { max-width:1200px; margin:15px auto; padding:0 15px; }
h1 { margin-bottom:15px; color:#333; }
.week-nav { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.btn-week { padding:4px 8px; font-size:13px; border:none; border-radius:5px; background:#007bff; color:white; cursor:pointer; }
.btn-week:hover { background:#0056b3; }
.tabs { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
.tab { padding:8px 12px; background:#007bff; color:white; border-radius:6px; cursor:pointer; font-size:14px; }
.tab.active { background:#0056b3; }
.card { border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); padding:15px; margin-bottom:10px; background:white; }
.dia-header { cursor:pointer; background:#e2e6ea; padding:8px; border-radius:6px; margin-bottom:5px; display:flex; align-items:center; font-weight:600; gap:8px; }
.dia-header .toggle-arrow { margin-right:6px; }
.dia-header .fecha { margin-right:8px; }
.dia-header input[type="checkbox"] { margin-left:auto; transform:scale(1.1); cursor:pointer; }
.dia-content { margin-bottom:10px; }
table { width:100%; border-collapse:collapse; margin-top:5px; }
th, td { padding:6px; border:1px solid #ddd; text-align:left; font-size:13px; white-space:nowrap; }
th { background:#343a40; color:white; }
tr:nth-child(even) td { background:transparent; } /* keep stripes neutral, use row class for color */
.action-buttons { display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
.btn-publicar { background:#28a745; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }
.btn-publicar:hover { background:#218838; }
.btn-privar { background:#6c757d; color:white; border:none; border-radius:6px; padding:6px 12px; cursor:pointer; }
.btn-privar:hover { background:#5a6268; }

/* Row colors: cada fila según t.is_public */
tr.turno-publico td { background-color: #d4edda !important; } /* verde claro */
tr.turno-borrador td { background-color: #cce5ff !important; } /* celeste */

.check-master { transform:scale(1.05); cursor:pointer; }
@media (max-width:768px){ .tabs{flex-direction:column;} table, th, td{font-size:12px;} }
</style>
</head>
<body>
    <div class="container py-4">
    <!-- Navbar -->
    {% include 'nav_bar.html' %}


    <h1>Planificación</h1>


<!-- Mensajes de creación, edición, etc -->
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
    {% endwith %}


    <div class="week-nav">
        <a href="{{ url_for('planificacion_index', week_start=prev_week.strftime('%Y-%m-%d')) }}" class="btn-week">⬅ Semana anterior</a>
        <span>Semana del {{ week_start.strftime('%d-%m-%Y') }} al {{ week_end.strftime('%d-%m-%Y') }}</span>
        <a href="{{ url_for('planificacion_index', week_start=next_week.strftime('%Y-%m-%d')) }}" class="btn-week">Semana siguiente ➡</a>
    </div>

    <div class="tabs">
        {% for punto in puntos %}
        <div class="tab {% if loop.first %}active{% endif %}" onclick="showTab({{ loop.index0 }})">
            {{ punto.punto_nombre }}
        </div>
        {% endfor %}
    </div>

    {% for punto in puntos %}
    <div class="card punto-card" data-punto="{{ punto.id }}" style="{% if not loop.first %}display:none{% endif %}">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
            <h2 style="margin:0;">{{ punto.punto_nombre }}</h2>
            <!-- checkbox maestro del punto (toda la semana) -->
            <label style="margin-left:auto; display:flex; align-items:center; gap:6px; font-weight:600;">
                <input type="checkbox" class="check-semana check-master" data-punto="{{ punto.id }}" title="Seleccionar todos los turnos de este punto (toda la semana)">
                <span style="font-size:13px; color:#333;">Seleccionar semana</span>
            </label>
        </div>

        <form id="form_planificacion_{{ punto.id }}" action="{{ url_for('planificacion_actualizar') }}" method="POST">
            <input type="hidden" name="punto_id" value="{{ punto.id }}">
            <input type="hidden" name="week_start" value="{{ week_start.strftime('%Y-%m-%d') }}">

            <div class="action-buttons">
                <button type="submit" name="accion" value="publicar" class="btn-publicar">Hacer públicos los seleccionados</button>
                <button type="submit" name="accion" value="privado" class="btn-privar">Pasar a borrador los seleccionados</button>
            </div>

            {% for dia, turnos_dia in turnos[punto.id].items() %}
            <div class="dia-section">
                <div class="dia-header" data-dia="{{ dia }}">
                    <span class="toggle-arrow">▼</span>
                    <span class="fecha">{{ dia.capitalize() }} – {{ turnos_dia[0]['fecha'].strftime('%d-%m-%Y') }}</span>
                    <!-- checkbox maestro del día: colocado pegado a la fecha -->
                    <input type="checkbox" class="check-dia check-master" data-punto="{{ punto.id }}" data-dia="{{ dia }}" title="Seleccionar todos los turnos del día" onclick="event.stopPropagation()">
                </div>

                <div class="dia-content">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:40px;"></th>
                                <th>Hora Inicio</th>
                                <th>Hora Fin</th>
                                <th>Capitán</th>
                                <th>Publicador 1</th>
                                <th>Publicador 2</th>
                                <th>Publicador 3</th>
                                <th>Publicador 4</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for t in turnos_dia %}
                            <tr class="turno-{{ 'publico' if t.is_public else 'borrador' }}">
                                <td style="text-align:center;">
                                    <input type="checkbox" class="turno-checkbox" data-punto="{{ punto.id }}" data-dia="{{ dia }}" name="turno_ids" value="{{ t['id'] }}">
                                </td>
                                <td>{{ t['hora_inicio'].strftime('%H:%M') if t['hora_inicio'] else '-' }}</td>
                                <td>{{ t['hora_fin'].strftime('%H:%M') if t['hora_fin'] else '-' }}</td>
                                <td>{{ t['capitan_nombre'] or '-' }}</td>
                                <td>{{ t['publicador1_nombre'] or '-' }}</td>
                                <td>{{ t['publicador2_nombre'] or '-' }}</td>
                                <td>{{ t['publicador3_nombre'] or '-' }}</td>
                                <td>{{ t['publicador4_nombre'] or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </form>
    </div>
    {% endfor %}
</div>

<script>
/* Tabs y toggle dia */
const cards = document.querySelectorAll('.punto-card');
const tabs = document.querySelectorAll('.tab');
function showTab(index){
    cards.forEach((c,i)=>c.style.display=i===index?'block':'none');
    tabs.forEach((t,i)=>t.classList.toggle('active', i===index));
}
document.querySelectorAll('.dia-header').forEach(h=>{
    h.addEventListener('click', function(){
        const content = this.nextElementSibling;
        content.style.display = (content.style.display === 'none') ? 'block' : 'none';
        const arrow = this.querySelector('.toggle-arrow');
        arrow.textContent = content.style.display === 'none' ? '►' : '▼';
    });
});

/* Toggle por día */
document.querySelectorAll('.check-dia').forEach(cb=>{
    cb.addEventListener('change', function(e){
        const puntoId = this.dataset.punto;
        const dia = this.dataset.dia;
        const card = document.querySelector(`.punto-card[data-punto='${puntoId}']`);
        const checkboxes = card.querySelectorAll(`.turno-checkbox[data-dia='${dia}']`);
        checkboxes.forEach(ch => ch.checked = this.checked);
        syncPuntoMasterState(puntoId);
    });
});

/* Toggle por semana (punto) */
document.querySelectorAll('.check-semana').forEach(cb=>{
    cb.addEventListener('change', function(){
        const puntoId = this.dataset.punto;
        const card = document.querySelector(`.punto-card[data-punto='${puntoId}']`);
        const allTurnos = card.querySelectorAll('.turno-checkbox');
        allTurnos.forEach(ch => ch.checked = this.checked);
        // sincronizar check-dia
        card.querySelectorAll('.check-dia').forEach(d => d.checked = this.checked);
    });
});

/* Si cambia un checkbox individual, actualizar masters del día y de la semana */
document.querySelectorAll('.turno-checkbox').forEach(cb=>{
    cb.addEventListener('change', function(){
        const puntoId = this.dataset.punto;
        const dia = this.dataset.dia;
        // actualizar checkbox de dia
        const card = document.querySelector(`.punto-card[data-punto='${puntoId}']`);
        const dayChecks = card.querySelectorAll(`.turno-checkbox[data-dia='${dia}']`);
        const dayMaster = card.querySelector(`.check-dia[data-dia='${dia}']`);
        if (dayMaster) {
            dayMaster.checked = Array.from(dayChecks).every(c=>c.checked);
        }
        // actualizar checkbox de semana
        syncPuntoMasterState(puntoId);
    });
});

function syncPuntoMasterState(puntoId){
    const card = document.querySelector(`.punto-card[data-punto='${puntoId}']`);
    if (!card) return;
    const allTurnos = card.querySelectorAll('.turno-checkbox');
    const semanaMaster = card.querySelector(`.check-semana[data-punto='${puntoId}']`);
    if (semanaMaster) {
        semanaMaster.checked = allTurnos.length > 0 && Array.from(allTurnos).every(c=>c.checked);
    }
    // también sincronizar cada day master
    card.querySelectorAll('.check-dia').forEach(d => {
        const dia = d.dataset.dia;
        const dayChecks = card.querySelectorAll(`.turno-checkbox[data-dia='${dia}']`);
        d.checked = dayChecks.length > 0 && Array.from(dayChecks).every(c=>c.checked);
    });
}

/* inicializar estado de masters según checkboxes actuales (al cargar) */
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.punto-card').forEach(card=>{
        const puntoId = card.dataset.punto;
        syncPuntoMasterState(puntoId);
    });
});
</script>

</body>
</html>
