<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Publicadores</title>

    <!-- Bootstrap y iconos -->

    <style>
        body { background-color: #f8f9fa; }
        h1 { margin-bottom: 30px; }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; }
        .table thead { background-color: #0d6efd; color: white; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .btn-custom { min-width: 80px; }
        @media (max-width: 768px) {
            .btn-custom { min-width: 60px; font-size: 0.8rem; padding: 0.25rem 0.5rem; }
        }
        th.sortable { cursor: pointer; }
        th.sortable i { margin-left: 5px; }
    </style>
</head>
<body class="container py-4">

    <!-- Navbar -->
    {% include 'nav_bar.html' %}

    <h1 class="text-center">Gestión de Publicadores</h1>

<!-- Mensajes de creación, edición, etc -->
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
    {% endwith %}


    <!-- Formulario colapsable -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>Nuevo / Editar Publicador</span>
            <button class="btn btn-light btn-sm d-flex align-items-center" type="button" data-bs-toggle="collapse" data-bs-target="#formPublicador" aria-expanded="false" aria-controls="formPublicador">
                <i class="bi bi-person-circle me-1"></i> Abrir / Cerrar
            </button>
        </div>
        <div class="collapse" id="formPublicador">
            <div class="card-body">
                <form method="POST" action="{{ url_for('publicadores_guardar') }}">
                    <input type="hidden" name="id" value="{{ publicador.id if publicador else '' }}">
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label">Nombre</label>
                            <input class="form-control" name="nombre" value="{{ publicador.nombre if publicador else '' }}" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Apellido</label>
                            <input class="form-control" name="apellido" value="{{ publicador.apellido if publicador else '' }}" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Nombre de Usuario</label>
                            <input class="form-control" name="usuario" value="{{ publicador.usuario if publicador else '' }}" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Mail</label>
                            <input type="email" class="form-control" name="mail" value="{{ publicador.mail if publicador else '' }}" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Celular</label>
                            <input class="form-control" name="celular" value="{{ publicador.celular if publicador else '' }}" required>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Congregación</label>
                            <input class="form-control" name="congregacion" value="{{ publicador.congregacion if publicador else '' }}">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Circuito</label>
                            <input class="form-control" name="circuito" value="{{ publicador.circuito if publicador else '' }}">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Rol</label>
                            <select class="form-select" name="rol" required>
                                <option value="Publicador" {% if publicador and publicador.rol=='Publicador' %}selected{% endif %}>Publicador</option>
                                <option value="Admin" {% if publicador and publicador.rol=='Admin' %}selected{% endif %}>Admin</option>
                                <option value="Capitán" {% if publicador and publicador.rol=='Capitán' %}selected{% endif %}>Capitán</option>
                                <option value="Encargado de Punto" {% if publicador and publicador.rol=='Encargado de Punto' %}selected{% endif %}>Encargado de Punto</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Contraseña</label>
                            <input type="password" class="form-control" name="password" autocomplete="new-password">
                        </div>
                        <div class="col-12 col-md-6">
                            <label class="form-label">Confirmar Contraseña</label>
                            <input type="password" class="form-control" name="password_confirm" autocomplete="new-password">
                        </div>
						<div class="col-12 col-md-6">
							<label class="form-label">Principiante</label>
							<select class="form-select" name="principiante">
							<option value="0" {% if publicador and not publicador.principiante %}selected{% endif %}>No</option>
							<option value="1" {% if publicador and publicador.principiante %}selected{% endif %}>Sí</option>
							</select>
						</div>
						<div class="col-12 col-md-6">
							<label class="form-label">Última Participación</label>
							<input type="date" class="form-control" name="ultima_participacion"
							value="{% if publicador and publicador.ultima_participacion %}{{ publicador.ultima_participacion.strftime('%Y-%m-%d') }}{% endif %}">
						</div>
                    </div>

                    <div class="mt-3 d-flex flex-wrap gap-2">
                        <button class="btn btn-primary btn-lg" type="submit">Guardar</button>
                        <a href="{{ url_for('publicadores_index') }}" class="btn btn-secondary btn-lg">Cancelar</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Buscador -->
    <div class="mb-3">
        <input class="form-control" id="searchInput" placeholder="Filtrar publicadores por nombre, apellido o usuario">
    </div>

    <!-- Listado -->
    <div class="table-responsive shadow-sm">
        <table class="table table-bordered table-striped table-hover" id="publicadoresTable">
            <thead>
                <tr>
                    <th class="sortable">Nombre <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Apellido <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Usuario <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Celular <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Mail <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Congregación <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Circuito <i class="bi bi-arrow-down-up"></i></th>
                    <th class="sortable">Rol <i class="bi bi-arrow-down-up"></i></th>
					<th class="sortable">Principiante<i class="bi bi-arrow-down-up"></th>
					<th class="sortable">Última Part.<i class="bi bi-arrow-down-up"></th>

                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pub in publicadores %}
                <tr>
                    <td>{{ pub.nombre }}</td>
                    <td>{{ pub.apellido }}</td>
                    <td>{{ pub.usuario }}</td>
                    <td>{{ pub.celular }}</td>
                    <td>{{ pub.mail }}</td>
                    <td>{{ pub.congregacion }}</td>
                    <td>{{ pub.circuito }}</td>
                    <td>{{ pub.rol }}</td>
					<td>{{ "Sí" if pub.principiante else "No" }}</td>
					<td>{{ pub.ultima_participacion if pub.ultima_participacion else "-" }}</td>

                    <td class="text-center">
                        <a href="{{ url_for('publicadores_editar', id=pub.id) }}" class="btn btn-sm btn-warning btn-custom mb-1">Editar</a>
                        <a href="{{ url_for('publicadores_eliminar', id=pub.id) }}" class="btn btn-sm btn-danger btn-custom mb-1"
                           onclick="return confirm('¿Seguro que querés eliminar este publicador?');">Eliminar</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center">No hay publicadores cargados</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Filtro de tabla -->
    <script>
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("keyup", function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#publicadoresTable tbody tr");
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        });
    </script>

    <!-- Ordenar columnas -->
    <script>
        document.querySelectorAll("th.sortable").forEach(th => {
            th.addEventListener("click", function() {
                const table = th.closest("table");
                const tbody = table.querySelector("tbody");
                const index = Array.from(th.parentNode.children).indexOf(th);
                const asc = !th.asc;
                th.asc = asc;

                const rows = Array.from(tbody.querySelectorAll("tr")).sort((a,b) => {
                    const aText = a.children[index].textContent.trim().toLowerCase();
                    const bText = b.children[index].textContent.trim().toLowerCase();
                    return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
                });

                rows.forEach(row => tbody.appendChild(row));
            });
        });
    </script>

    <!-- Validar contraseñas -->
    <script>
        const form = document.querySelector("form");
        form.addEventListener("submit", function(e) {
            const pwd = form.password.value;
            const pwdConfirm = form.password_confirm.value;
            if (pwd || pwdConfirm) {
                if (pwd !== pwdConfirm) {
                    e.preventDefault();
                    alert("Las contraseñas no coinciden");
                }
            }
        });
    </script>

<script>
    // Abrir automáticamente el formulario si estamos editando
    document.addEventListener("DOMContentLoaded", function() {
        const publicadorId = "{{ publicador.id if publicador else '' }}";
        if (publicadorId) {
            const collapseEl = document.getElementById('formPublicador');
            const bsCollapse = new bootstrap.Collapse(collapseEl, { toggle: true });
        }
    });
</script>


</body>
</html>
