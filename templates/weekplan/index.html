<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gesti√≥n de Turnos</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous"
/>
  <!-- CSS locales -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app_turnos.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='imagenes/logo_ppam.png') }}">

  <style>
    body { background: #f3f4f6; font-family: sans-serif; }
    .ppam-logo { width: 40px; transition: transform 0.25s ease; }
    .ppam-logo:hover { transform: scale(0.95); opacity: 0.9; }
  </style>
</head>

<body class="bg-gray-100 font-sans">

  <!-- üî∑ Encabezado -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <a href="https://metropoliplan.appwebterritorios.com" title="Volver atr√°s">‚üµ Inicio</a>
    <h1 class="text-lg font-semibold">Gesti√≥n de Turnos ‚Äî PPAM 2025</h1>
    <img src="{{ url_for('static', filename='imagenes/logo_ppam.png') }}" alt="PPAM logo" class="ppam-logo">
  </header>

  <!-- üîπ Contenedor principal -->
  <main class="p-4">
    <h2 class="text-xl font-bold mb-2">Panel de planificaci√≥n de turnos</h2>

     <!-- TAB PLANIFICAR -->
    <div id="tab-planificar" class="tab-content hidden">
	<div id="planificador_turnos" class="hidden"></div>
      <div class="flex justify-between items-center mb-4">     	
     </div>
     </div>	  

    <div class="mt-4 flex gap-3">
      <button id="cargarTurnosBtn" class="bg-blue-500 text-white px-3 py-1 rounded">Cargar Turnos</button>
	   <button onclick="mostrarTab('planificar')" class="tab-btn px-4 py-2 bg-indigo-500 text-white rounded ">Planificar Turnos</button>&nbsp;
      <button id="asignarTurno" class="bg-emerald-500 text-white px-3 py-1 rounded">Asignar AUTO</button>
      <button onclick="mostrarTab('pipeline')" class="bg-purple-600 text-white px-3 py-1 rounded">Ver flujo Bot</button>
	  
    </div>

    <div id="turnosList" class="mt-4 grid gap-4"></div>

    <!-- üî∏ Pipeline -->
    <section id="tab-pipeline" class="hidden mt-6">
      <h3 class="text-lg font-semibold mb-2">Flujo del Bot Asignador</h3>
      <button onclick="actualizarPipeline()" class="bg-blue-500 text-white px-3 py-1 rounded">Actualizar</button>
      <pre id="pipelineOutput" class="bg-black text-green-300 font-mono text-xs p-3 rounded overflow-y-auto h-[400px] whitespace-pre-wrap mt-3">(sin datos)</pre>
    </section>
	
	<!-- MODAL: Asignaci√≥n autom√°tica por rango -->
<div id="modalRango" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-xl w-[320px]">
    <h2 class="text-xl font-bold mb-4">Asignaci√≥n Autom√°tica</h2>

    <label class="block mb-2">
      Desde:
      <input id="asigDesde" type="date" class="form-control">
    </label>

    <label class="block mb-4">
      Hasta:
      <input id="asigHasta" type="date" class="form-control">
    </label>

    <div class="flex justify-end gap-3">
      <button onclick="cerrarModalRango()" class="px-3 py-1 bg-gray-500 text-white rounded">Cancelar</button>
      <button onclick="confirmarAsignacionRango()" class="px-3 py-1 bg-emerald-600 text-white rounded">Asignar</button>
    </div>
  </div>
</div>

			
  </main>

  <!-- üî∏ Scripts -->
  <!-- jQuery (OBLIGATORIO antes del planificador) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{{ url_for('static', filename='js/planificador_interactivo_flask.js') }}"></script>
  <script>
  // cuando se muestra el tab de entorno, cargar las configuraciones	
	function mostrarTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
  const activeTab = document.getElementById("tab-" + tab);
  activeTab.classList.remove("hidden");

  // üîπ Desoculta elementos internos del tab
  activeTab.querySelectorAll(".hidden").forEach(el => el.classList.remove("hidden"));

  if (tab === "entorno") {
    cargarConfiguraciones();
    }
	
	/* if (tab === "turnos" || tab === "puntos" || tab === "solicitudes") {
  
      } */
	  
  if (tab === "planificar") {
    PlanificadorInteractivo.init();
    }
	
	if (tab === "turnos") {
    document.getElementById("modalCrear").classList.add("hidden");
    }
	
	
}

// ---------- PIPELINE BOT ----------
let lastPipelineText = "";

async function actualizarPipeline() {
  const res = await fetch("/tmp/bot_log.json?ts=" + Date.now());
  if (!res.ok) {
    document.getElementById("pipelineOutput").innerText = "Error al cargar el pipeline.";
    return;
  }
  const data = await res.json();

  // Mostrar el texto si lo trae directo
  if (data.pipeline_text) {
    lastPipelineText = data.pipeline_text;
    document.getElementById("pipelineOutput").innerText = data.pipeline_text;
  } 
  // O bien si hay un archivo disponible
  else if (data.pipeline_url) {
    try {
      const txtRes = await fetch(".." + data.pipeline_url);
      const txt = await txtRes.text();
      lastPipelineText = txt;
      document.getElementById("pipelineOutput").innerText = txt;
    } catch (e) {
      document.getElementById("pipelineOutput").innerText = "Error leyendo archivo del pipeline.";
    }
  } 
  else {
    document.getElementById("pipelineOutput").innerText = "No hay datos de pipeline disponibles a√∫n.";
  }
}

// Mostrar el pipeline m√°s reciente en una pesta√±a nueva (opcional)
function abrirPipelineEnNuevaPesta√±a() {
  if (!lastPipelineText) {
    alert("No hay pipeline cargado a√∫n.");
    return;
  }
  const w = window.open();
  w.document.write('<pre style="background:#000;color:#0f0;font-family:monospace;padding:1em;">' + 
                   lastPipelineText.replace(/[<>]/g, c => c === '<' ? '&lt;' : '&gt;') +
                   '</pre>');
  w.document.title = "Pipeline Bot Asignador";
}

// ------ LOG DEL BOT (JSON) ------
async function actualizarBotLog() {
  try {
    const res = await fetch("/tmp/bot_log.json?cache=" + Date.now());
    if (!res.ok) throw new Error(`Error al leer bot_log.json (${res.status})`);
    const jsonText = await res.text();

    try {
      // Intenta formatear bonito
      const data = JSON.parse(jsonText);
      document.getElementById("botLogOutput").innerHTML = syntaxHighlight(data);
    } catch {
      document.getElementById("botLogOutput").innerText = jsonText;
    }
  } catch (err) {
    document.getElementById("botLogOutput").innerText = "Error al cargar log: " + err.message;
  }
}

function abrirBotLogNuevaPesta√±a() {
  window.open("/tmp/bot_log.json", "_blank");
}

// ------ Formateador de JSON con colores ------
function syntaxHighlight(json) {
  if (typeof json != "string") json = JSON.stringify(json, undefined, 2);
  json = json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b[\d.]+\b)/g, function (match) {
    let cls = "text-green-400";
    if (/^"/.test(match)) {
      if (/:$/.test(match)) cls = "text-blue-300 font-semibold";
      else cls = "text-yellow-300";
    } else if (/true|false/.test(match)) cls = "text-purple-300";
    else if (/null/.test(match)) cls = "text-gray-400 italic";
    return `<span class="${cls}">${match}</span>`;
  });
}

document.getElementById("cargarTurnosBtn").addEventListener("click", cargarTurnos);

async function cargarTurnos() {
  const cont = document.getElementById("turnosList");
  cont.innerHTML = "Cargando...";

  const res = await fetch("/api/turnos?accion=listar")
  const turnos = await res.json();

  cont.innerHTML = "";

  turnos.forEach(t => {
    const card = document.createElement("div");
    card.className = "p-3 bg-white shadow rounded";

    card.innerHTML = `
      <div class="font-bold text-lg">Turno #${t.id}</div>
      <div>${t.fecha} ‚Äî ${t.hora_inicio} a ${t.hora_fin}</div>
      <div><b>Punto:</b> ${t.punto}</div>
      <div class="mt-2">
          <button class="asignarBtn bg-emerald-600 text-white px-2 py-1 rounded" data-id="${t.id}">
            Ejecutar Bot para este turno
          </button>
      </div>
    `;

    cont.appendChild(card);
  });

  // Activar botones ‚ÄúEjecutar Bot‚Äù
  document.querySelectorAll(".asignarBtn").forEach(btn => {
    btn.addEventListener("click", () => ejecutarBot(btn.dataset.id));
  });
}

async function ejecutarBot(turnoID) {
  alert("Ejecutando bot para turno " + turnoID);

  const res = await fetch("/api/bot/ejecutar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "turno",
      turno_id: parseInt(turnoID)
    })
  });

  const data = await res.json();
  console.log("Respuesta del bot:", data);

  if (!data.ok) {
    alert("Error: " + data.error);
    return;
  }

  alert("Bot ejecutado. Usuarios asignados: " + JSON.stringify(data.assigned));

  // refrescar pipeline visible
  actualizarPipeline();
}
// ------------------------ ASIGNAR AUTO -----------------------------------------
// Abrir modal
document.getElementById("asignarTurno").addEventListener("click", () => {
    document.getElementById("modalRango").classList.remove("hidden", "opacity-0");
});

// Cerrar modal
function cerrarModalRango() {
    document.getElementById("modalRango").classList.add("hidden");
}

// Confirmar y llamar API
async function confirmarAsignacionRango() {
    const desde = document.getElementById("asigDesde").value;
    const hasta = document.getElementById("asigHasta").value;

    if (!desde || !hasta) {
        alert("Debe ingresar ambas fechas.");
        return;
    }

    cerrarModalRango();

    const payload = {
        mode: "rango",
        fecha_desde: desde,
        fecha_hasta: hasta
    };

    const res = await fetch("/api/bot/asignar_rango", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("Asignaci√≥n resultado:", data);

    alert("Asignaci√≥n autom√°tica por rango completa. Revise el pipeline.");

    // refrescar pipeline para ver info
    actualizarPipeline();
}
  </script>
</body>
</html>
