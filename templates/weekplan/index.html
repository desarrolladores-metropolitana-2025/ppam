<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gesti√≥n de Turnos</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
<!-- Bootstrap CSS -->
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous"
/>
  <!-- CSS locales -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app_turnos.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='imagenes/logo_ppam.png') }}">

  <style>
    body { background: #f3f4f6; font-family: sans-serif; }
    .ppam-logo { width: 40px; transition: transform 0.25s ease; }
    .ppam-logo:hover { transform: scale(0.95); opacity: 0.9; }
  </style>
</head>

<body class="bg-gray-100 font-sans">

  <!-- üî∑ Encabezado -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <a href="https://ppamappcaba.pythonanywhere.com/main" title="Volver atr√°s">‚üµ Inicio</a>
    <h1 class="text-lg font-semibold">Panel de planificaci√≥n de Turnos ‚Äî PPAM 2025</h1>
    <img src="{{ url_for('static', filename='imagenes/logo_ppam.png') }}" alt="PPAM logo" class="ppam-logo">
  </header>
<nav class="flex  bg-gray-200 p-2">  
  <div class="mt-4 flex gap-3">
      <button id="cargarTurnosBtn" onclick="mostrarTab('turnos')" class="bg-cyan-500 text-white px-3 py-1 rounded">Cargar Turnos</button>
	  <button id="cargarPuntosBtn" onclick="mostrarTab('puntos')" class="tab-btn px-3 py-1 bg-lime-500 rounded mr-2">Puntos</button>
    <button onclick="mostrarTab('solicitudes')" class="tab-btn px-3 py-1 bg-teal-500 rounded">Solicitudes</button>
	   <button onclick="mostrarTab('planificar')" class="tab-btn px-3 py-1 bg-indigo-500 text-white rounded ">Planificar Turnos</button>
      <button id="asignarTurno" class="bg-emerald-500 text-white px-3 py-1 rounded">Asignar AUTO</button>
      <button onclick="mostrarTab('pipeline')" class="bg-purple-600 text-white px-3 py-1 rounded">Ver flujo Bot</button>
	  <button onclick="enviarNotificaciones()" class="tab-btn px-3 py-1 bg-amber-500 text-white rounded ">Enviar notificaciones</button>
	 <button onclick="mostrarTab('entorno')" class="tab-btn px-3 py-1 bg-green-500 rounded">Ver entorno</button>
	 <button onclick="mostrarTab('estadisticas')" class="tab-btn px-3 py-1 bg-red-500 text-white rounded ">Estad&iacute;sticas</button>
	 </div>
</nav>
  <!-- üîπ Contenedor principal &nbsp; -->
  <main class="p-4">
    <!-- <h2 class="text-xl font-bold mb-2">Panel de planificaci√≥n de turnos</h2> -->

     <!-- TAB PLANIFICAR -->
    <div id="tab-planificar" class="tab-content hidden">
	<div id="planificador_turnos" class="hidden"></div>
      <div class="flex justify-between items-center mb-4">     	
     </div>
     </div>	  
	 <!-- TAB PUNTOS -->
    <div id="tab-puntos" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Puntos de Predicaci√≥n</h2>
      <div id="puntosList" class="grid gap-4"></div>
    </div>
	
  <!-- TAB SOLICITUDES -->
    <div id="tab-solicitudes" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Solicitudes</h2>

      <!-- Formulario -->
      <form id="formSolicitud" class="bg-white p-4 rounded shadow mb-4 flex flex-col gap-2 max-w-md">
       <label for="turnoSelect">Selecciona punto:</label>
<select id="turnoSelect" name="punto_id" class="border rounded w-full p-1"></select>
	  
        <label>
          Rol:
          <select id="rolSelect" name="rol" class="border rounded w-full p-1">
            <option value="publicador">Publicador</option>
            <option value="capitan">Capit√°n</option>
          </select>
        </label>
        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded">Postularse</button>
      </form>

      <!-- Lista -->
      <div id="solicitudesList" class="grid gap-4"></div>
    </div>   
<!-- TAB TURNOS -->
    <div id="tab-turnos" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Turnos</h2>
      <div id="turnosList" class="mt-4 grid gap-4"></div>
    </div>
<!-- TAB ENTORNO -->
<div id="tab-entorno" class="tab-content hidden">
  <h2 class="text-xl font-bold mb-4">Configuraciones del Entorno</h2>
  <div id="configList" class="grid gap-4"></div>
</div>
<!-- TAB ESTADISTICAS -->
<div id="tab-estadisticas" class="tab-content hidden">
  <h2 class="text-xl font-bold mb-4">Estad√≠sticas</h2>
  <div id="statsContainer" class="grid grid-cols-2 gap-4"></div>
</div>

    

    <!-- üî∏ Pipeline -->
    <section id="tab-pipeline" class="tab-content hidden mt-6">
      <h3 class="text-lg font-semibold mb-2">Flujo del Bot Asignador</h3>
      <button onclick="actualizarPipeline()" class="bg-blue-500 text-white px-3 py-1 rounded">Actualizar</button>
      <pre id="pipelineOutput" class="bg-black text-green-300 font-mono text-xs p-3 rounded overflow-y-auto h-[400px] whitespace-pre-wrap mt-3">(sin datos)</pre>
    </section>
	
	<!-- MODAL: Asignaci√≥n autom√°tica por rango -->
<div id="modalRango" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white p-6 rounded shadow-xl w-[320px]">
    <h2 class="text-xl font-bold mb-4">Asignaci√≥n Autom√°tica</h2>

    <label class="block mb-2">
      Desde:
      <input id="asigDesde" type="date" class="form-control">
    </label>

    <label class="block mb-4">
      Hasta:
      <input id="asigHasta" type="date" class="form-control">
    </label>

    <div class="flex justify-end gap-3">
      <button onclick="cerrarModalRango()" class="px-3 py-1 bg-gray-500 text-white rounded">Cancelar</button>
      <button onclick="confirmarAsignacionRango()" class="px-3 py-1 bg-emerald-600 text-white rounded">Asignar</button>
    </div>
  </div>
</div>

			
  </main>

  <!-- üî∏ Scripts -->
  <!-- jQuery (OBLIGATORIO antes del planificador) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{{ url_for('static', filename='js/planificador_interactivo_flask.js') }}"></script>
  <script>
  // cuando se muestra el tab de entorno, cargar las configuraciones	
	function mostrarTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
  const activeTab = document.getElementById("tab-" + tab);
 
  activeTab.classList.remove("hidden");

  // üîπ Desoculta elementos internos del tab
  activeTab.querySelectorAll(".hidden").forEach(el => el.classList.remove("hidden"));

  if (tab === "entorno") {
    cargarConfiguraciones();
    }
	
	/* if (tab === "turnos" || tab === "puntos" || tab === "solicitudes") {
  
      } */
	  
  if (tab === "planificar") {
    PlanificadorInteractivo.init();
    }
	
	if (tab === "turnos") {	
    // document.getElementById("modalCrear").classList.add("hidden");
	// alert("Mostrando turnos");
    }
	
	if (tab === "puntos") {
	    cargarPuntos();
}

if (tab === "solicitudes") {
    cargarSolicitudes();
    cargarSelectPuntos();
}

if (tab === "estadisticas") {
	    verEstadisticas();
}

	
	
}

// ---------- PIPELINE BOT ----------
let lastPipelineText = "";

async function actualizarPipeline() {
  const res = await fetch("/tmp/bot_log.json?ts=" + Date.now());
  if (!res.ok) {
    document.getElementById("pipelineOutput").innerText = "Error al cargar el pipeline.";
    return;
  }
  const data = await res.json();

  // Mostrar el texto si lo trae directo
  if (data.pipeline_text) {
    lastPipelineText = data.pipeline_text;
    document.getElementById("pipelineOutput").innerText = data.pipeline_text;
  } 
  // O bien si hay un archivo disponible
  else if (data.pipeline_url) {
    try {
      const txtRes = await fetch(".." + data.pipeline_url);
      const txt = await txtRes.text();
      lastPipelineText = txt;
      document.getElementById("pipelineOutput").innerText = txt;
    } catch (e) {
      document.getElementById("pipelineOutput").innerText = "Error leyendo archivo del pipeline.";
    }
  } 
  else {
    document.getElementById("pipelineOutput").innerText = "No hay datos de pipeline disponibles a√∫n.";
  }
}

// Mostrar el pipeline m√°s reciente en una pesta√±a nueva (opcional)
function abrirPipelineEnNuevaPesta√±a() {
  if (!lastPipelineText) {
    alert("No hay pipeline cargado a√∫n.");
    return;
  }
  const w = window.open();
  w.document.write('<pre style="background:#000;color:#0f0;font-family:monospace;padding:1em;">' + 
                   lastPipelineText.replace(/[<>]/g, c => c === '<' ? '&lt;' : '&gt;') +
                   '</pre>');
  w.document.title = "Pipeline Bot Asignador";
}

// ------ LOG DEL BOT (JSON) ------
async function actualizarBotLog() {
  try {
    const res = await fetch("/tmp/bot_log.json?cache=" + Date.now());
    if (!res.ok) throw new Error(`Error al leer bot_log.json (${res.status})`);
    const jsonText = await res.text();

    try {
      // Intenta formatear bonito
      const data = JSON.parse(jsonText);
      document.getElementById("botLogOutput").innerHTML = syntaxHighlight(data);
    } catch {
      document.getElementById("botLogOutput").innerText = jsonText;
    }
  } catch (err) {
    document.getElementById("botLogOutput").innerText = "Error al cargar log: " + err.message;
  }
}

function abrirBotLogNuevaPesta√±a() {
  window.open("/tmp/bot_log.json", "_blank");
}

// ------ Formateador de JSON con colores ------
function syntaxHighlight(json) {
  if (typeof json != "string") json = JSON.stringify(json, undefined, 2);
  json = json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b[\d.]+\b)/g, function (match) {
    let cls = "text-green-400";
    if (/^"/.test(match)) {
      if (/:$/.test(match)) cls = "text-blue-300 font-semibold";
      else cls = "text-yellow-300";
    } else if (/true|false/.test(match)) cls = "text-purple-300";
    else if (/null/.test(match)) cls = "text-gray-400 italic";
    return `<span class="${cls}">${match}</span>`;
  });
}

document.getElementById("cargarTurnosBtn").addEventListener("click", cargarTurnos);

async function cargarTurnos() {
  const cont = document.getElementById("turnosList");
  cont.innerHTML = "Cargando...";

  const res = await fetch("/api/turnos?accion=listar")
  const turnos = await res.json();

  cont.innerHTML = "";

  turnos.forEach(t => {
    const card = document.createElement("div");
    card.className = "p-3 bg-white shadow rounded";

    card.innerHTML = `
      <div class="font-bold text-lg">Turno #${t.id}</div>
      <div>${t.fecha} ‚Äî ${t.hora_inicio} a ${t.hora_fin}</div>
      <div><b>Punto:</b> ${t.punto}</div>
      <div class="mt-2">
          <button class="asignarBtn bg-emerald-600 text-white px-2 py-1 rounded" data-id="${t.id}">
            Ejecutar Bot para este turno
          </button>
      </div>
    `;

    cont.appendChild(card);
  });

  // Activar botones ‚ÄúEjecutar Bot‚Äù
  document.querySelectorAll(".asignarBtn").forEach(btn => {
    btn.addEventListener("click", () => ejecutarBot(btn.dataset.id));
  });
}

async function ejecutarBot(turnoID) {
  alert("Ejecutando bot para turno " + turnoID);

  const res = await fetch("/api/bot/ejecutar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "turno",
      turno_id: parseInt(turnoID)
    })
  });

  const data = await res.json();
  console.log("Respuesta del bot:", data);

  if (!data.ok) {
    alert("Error: " + data.error);
    return;
  }

  alert("Bot ejecutado. Usuarios asignados: " + JSON.stringify(data.assigned));

  // refrescar pipeline visible
  actualizarPipeline();
}
// ------------------------ ASIGNAR AUTO -----------------------------------------
// Abrir modal
document.getElementById("asignarTurno").addEventListener("click", () => {
    document.getElementById("modalRango").classList.remove("hidden", "opacity-0");
});

// Cerrar modal
function cerrarModalRango() {
    document.getElementById("modalRango").classList.add("hidden");
}

// Confirmar y llamar API
async function confirmarAsignacionRango() {
    const desde = document.getElementById("asigDesde").value;
    const hasta = document.getElementById("asigHasta").value;

    if (!desde || !hasta) {
        alert("Debe ingresar ambas fechas.");
        return;
    }

    cerrarModalRango();

    const payload = {
        mode: "rango",
        fecha_desde: desde,
        fecha_hasta: hasta
    };

    const res = await fetch("/api/bot/asignar_rango", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("Asignaci√≥n resultado:", data);

    alert("Asignaci√≥n autom√°tica por rango completa. Revise el pipeline.");

    // refrescar pipeline para ver info
    actualizarPipeline();
}
 
async function cargarPuntos() {
    const cont = document.getElementById("puntosList");
    cont.innerHTML = "<div class='text-gray-600 text-sm'>Cargando puntos...</div>";

    try {
        const res = await fetch("/api/puntos");
        const puntos = await res.json();

        cont.innerHTML = "";

        if (puntos.length === 0) {
            cont.innerHTML = "<div>No hay puntos cargados.</div>";
            return;
        }

        puntos.forEach(p => {
            const card = document.createElement("div");
            card.className = "p-3 bg-white shadow rounded border border-gray-200";

            card.innerHTML = `
                <h3 class="font-bold text-lg mb-1">${p.nombre}</h3>
                <p><b>Direcci√≥n:</b> ${p.direccion || '‚Äî'}</p>
                <p><b>Contacto:</b> ${p.contacto || '‚Äî'}</p>
                <p><b>Tel√©fono:</b> ${p.telefono || '‚Äî'}</p>
            `;

            cont.appendChild(card);
        });

    } catch (e) {
        cont.innerHTML = "<div class='text-red-600'>Error cargando puntos.</div>";
    }
}

 // ------ SOLICITUDES ------
    async function cargarSolicitudes() {
      const res = await fetch("/api/solicitudez");
      const solicitudes = await res.json();
      const list = document.getElementById("solicitudesList");
      list.innerHTML = "";

      solicitudes.forEach(s => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4 flex justify-between";
        card.innerHTML = `
          <div>
            <h3 class="font-semibold">Punto: ${s.punto}</h3>
			<h3 class="font-semibold">Turno: ${s.fecha}</h3>
			<h3 class="font-semibold">Publicador: ${s.usuario}</h3>
            <p class="text-gray-600">Rol: ${s.rol}</p>
            <p class="text-gray-500">Estado: ${s.estado}</p>
          </div>
          <button onclick="eliminarSolicitud(${s.id})" class="bg-red-500 text-white px-3 py-1 rounded">Cancelar</button>
        `;
        list.appendChild(card);
      });
    }

    document.getElementById("formSolicitud").addEventListener("submit", async e => {
      e.preventDefault();
      const data = new FormData(e.target);
      await fetch("/api/solicitudez", { method: "POST", body: data });

      cargarSolicitudes();
    });

    async function eliminarSolicitud(id) {
	await fetch(`/api/solicitudez/${id}`, { method: "DELETE" });
    cargarSolicitudes();
    }
	
	async function cargarSelectPuntos() {
  const res = await fetch("/api/puntos");
  const puntos = await res.json();

  const select = document.getElementById("turnoSelect");
  select.innerHTML = "<option value=''>-- Selecciona un punto --</option>";

  puntos.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;        // üëà este es el ID que se guarda en turnos.punto_id
    option.textContent = p.nombre; // üëà lo que ve el usuario
    select.appendChild(option);
  });
}

async function enviarNotificaciones() {
     // await fetch("../envios/cron_notificaciones.php", {
     //  });
	  
	 
  try {
    const res = await fetch("/api/notificaciones/enviar", {
      method: "POST"
    });


    // 1. Verificar si la respuesta es OK (status 200-299)
    if (!res.ok) {
      throw new Error(`Error en la petici√≥n: ${res.status}`);
    }

    const data = await res.json();

    // 2. Comprobar si el JSON contiene un mensaje de error del backend
    if (data.error) {
      alert(data.error); // Muestra el mensaje de error del backend
      console.error('Error del backend:', data.error);
    } else {
      // 3. Si no hay error, el proceso fue exitoso
      alert(data.msj);
  
      console.log('Mensaje del backend:', data.msj);
  
      cargarTurnos(); // Recarga la lista de turnos
    }
  } catch (error) {
    // 4. Capturar errores de red o errores de parseo de JSON
    // alert("Hubo un problema con la operaci√≥n. Intente nuevamente.");
    console.error('Error en la operaci√≥n:', error);
  }
  
   cargarTurnos();
   cargarSolicitudes();
} 

// ------ CONFIGURACIONES DEL ENTORNO (editable) ------
async function cargarConfiguraciones() {
  try {
    const res = await fetch("/api/config/list");
    const data = await res.json();

    const list = document.getElementById("configList");
    list.innerHTML = "";

    if (!data.ok) {
      list.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded">Error: ${data.error}</div>`;
      return;
    }

    const configuraciones = data.configuraciones;

    configuraciones.forEach(cfg => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-lg shadow p-4 border border-gray-200";
      card.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-semibold">${cfg.seccion} / ${cfg.clave}</h3>
          <span class="text-sm bg-gray-100 px-2 py-1 rounded">${cfg.tipo}</span>
        </div>
        <input id="valor-${cfg.id}" type="text" value="${cfg.valor}" 
               class="border rounded w-full p-2 text-gray-700" />
        <div class="flex justify-end mt-2">
          <button onclick="guardarConfiguracion(${cfg.id})" 
                  class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
            üíæ Guardar
          </button>
        </div>
      `;
      list.appendChild(card);
    });
  } catch (error) {
    console.error("Error cargando configuraciones:", error);
    const list = document.getElementById("configList");
    list.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded">Error al obtener configuraciones</div>`;
  }
}

// Guarda un valor editado
async function guardarConfiguracion(id) {
  const valor = document.getElementById(`valor-${id}`).value;

  try {
    const res = await fetch("/api/config/save", {
    method: "POST",
    body: new URLSearchParams({ id, valor })
    });

    const data = await res.json();

    if (data.ok) {
      alert("Configuraci√≥n actualizada correctamente.");
    } else {
      alert("Error: " + data.error);
    }
  } catch (err) {
    alert("Error de red o servidor.");
    console.error(err);
  }
}

async function verEstadisticas() {
  
  const box = document.getElementById("statsContainer");
  box.innerHTML = "Cargando datos...";

  const url = window.location.origin + "/api/estadisticas";
  const res = await fetch(url);
  const data = await res.json();

  if (!data.ok) {
    box.innerHTML = "<div class='text-red-600'>Error al cargar estad√≠sticas</div>";
    return;
  }

  const d = data.data;

  const html = `
    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Publicadores</p>
      <p class="text-3xl font-bold">${d.publicadores}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Puntos</p>
      <p class="text-3xl font-bold">${d.puntos}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Turnos totales</p>
      <p class="text-3xl font-bold">${d.turnos_totales}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Turnos hoy</p>
      <p class="text-3xl font-bold">${d.turnos_hoy}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Solicitudes</p>
      <p class="text-3xl font-bold">${d.solicitudes_pendientes}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Experiencias</p>
      <p class="text-3xl font-bold">${d.experiencias}</p>
    </div>

    <div class="bg-white p-4 rounded shadow text-center">
      <p class="text-gray-500 text-sm">Ausencias vigentes</p>
      <p class="text-3xl font-bold">${d.ausencias_vigentes}</p>
    </div>
  `;

  box.innerHTML = html;
}
</script>

</body>
</html>
