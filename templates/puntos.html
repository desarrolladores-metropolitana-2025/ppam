<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puntos de Predicación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        h1 { margin-bottom: 30px; }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; cursor: pointer; }
        .table thead { background-color: #0d6efd; color: white; }
        .table tbody tr:hover { background-color: #e9ecef; }
        .btn-custom { min-width: 80px; }
        .rotate { transition: transform 0.3s ease; }
        .rotate.down { transform: rotate(90deg); }
        @media (max-width: 768px) { .btn-custom { min-width: 60px; font-size: 0.8rem; padding: 0.25rem 0.5rem; } }
    </style>
</head>
<body class="container py-4">

    {% include 'nav_bar.html' %}

    <h1 class="text-center">Gestión de Puntos de Predicación</h1>


<!-- Mensajes de creación, edición, etc -->
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
    {% endwith %}


    <!-- Formulario Nuevo / Editar -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center" id="toggleForm">
            <span>Punto de Predicación</span>
            <span class="rotate" id="formArrow">▶</span>
        </div>
        <div class="card-body" id="formBody" style="display: none;">
            <form method="POST" action="{{ url_for('puntos_guardar') }}">
                <input type="hidden" name="id" value="{{ punto.id if punto else '' }}">

                <div class="mb-3">
                    <label class="form-label">Nombre del Punto</label>
                    <input class="form-control" name="punto_nombre" value="{{ punto.punto_nombre if punto else '' }}" required>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" name="fecha_inicio" value="{{ punto.fecha_inicio if punto else '' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" name="fecha_fin" value="{{ punto.fecha_fin if punto else '' }}">
                    </div>
                </div>

                <!-- Horarios -->
                <div class="mb-3">
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="sameStart"> Mismo horario de inicio para todos los días
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="sameEnd"> Mismo horario de fin para todos los días
                    </div>

                    <div class="row g-3">
                        {% for dia in ['lunes','martes','miercoles','jueves','viernes','sabado','domingo'] %}
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label text-capitalize">{{ dia }} Inicio</label>
                            <input type="time" class="form-control inicio-{{ dia }}" name="{{ dia }}_inicio"
                            value="{{ time_to_str(punto[dia+'_inicio']) if punto else '' }}">
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <label class="form-label text-capitalize">{{ dia }} Fin</label>
                            <input type="time" class="form-control fin-{{ dia }}" name="{{ dia }}_fin"
                            value="{{ time_to_str(punto[dia+'_fin']) if punto else '' }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Duración del Turno (min)</label>
                        <input type="number" class="form-control" name="duracion_turno" value="{{ punto.duracion_turno if punto else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Dirección del Depósito</label>
                        <input type="text" class="form-control" name="direccion_deposito" value="{{ punto.direccion_deposito if punto else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Contacto Depósito</label>
                        <input type="text" class="form-control" name="contacto_deposito" value="{{ punto.contacto_deposito if punto else '' }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Teléfono Depósito</label>
                        <input type="text" class="form-control" name="telefono_deposito" value="{{ punto.telefono_deposito if punto else '' }}">
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary btn-lg" type="submit">Guardar</button>
                    <a href="{{ url_for('puntos_index') }}" class="btn btn-secondary btn-lg">Cancelar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Buscador -->
    <div class="mb-3">
        <input class="form-control" id="searchInput" placeholder="Filtrar puntos por nombre o dirección">
    </div>

    <!-- Listado -->
    <div class="table-responsive shadow-sm">
        <table class="table table-bordered table-striped table-hover" id="puntosTable">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Lunes</th>
                    <th>Martes</th>
                    <th>Miércoles</th>
                    <th>Jueves</th>
                    <th>Viernes</th>
                    <th>Sábado</th>
                    <th>Domingo</th>
                    <th>Duración</th>
                    <th>Depósito</th>
                    <th>Contacto</th>
                    <th>Teléfono</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in puntos %}
                <tr>
                    <td>{{ p.punto_nombre }}</td>
                    <td>{{ p.fecha_inicio }}</td>
                    <td>{{ p.fecha_fin }}</td>
                    <td>{{ time_to_str(p.lunes_inicio) }} - {{ time_to_str(p.lunes_fin) }}</td>
                    <td>{{ time_to_str(p.martes_inicio) }} - {{ time_to_str(p.martes_fin) }}</td>
                    <td>{{ time_to_str(p.miercoles_inicio) }} - {{ time_to_str(p.miercoles_fin) }}</td>
                    <td>{{ time_to_str(p.jueves_inicio) }} - {{ time_to_str(p.jueves_fin) }}</td>
                    <td>{{ time_to_str(p.viernes_inicio) }} - {{ time_to_str(p.viernes_fin) }}</td>
                    <td>{{ time_to_str(p.sabado_inicio) }} - {{ time_to_str(p.sabado_fin) }}</td>
                    <td>{{ time_to_str(p.domingo_inicio) }} - {{ time_to_str(p.domingo_fin) }}</td>
                    <td>{{ p.duracion_turno }}</td>
                    <td>{{ p.direccion_deposito }}</td>
                    <td>{{ p.contacto_deposito }}</td>
                    <td>{{ p.telefono_deposito }}</td>
                    <td class="text-center">
                        <a href="{{ url_for('puntos_editar', id=p.id) }}" class="btn btn-sm btn-warning btn-custom mb-1">Editar</a>
                        <a href="{{ url_for('puntos_eliminar', id=p.id) }}" class="btn btn-sm btn-danger btn-custom mb-1"
                        onclick="return confirm('¿Seguro que querés eliminar este punto?');">Eliminar</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="15" class="text-center">No hay puntos cargados</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("keyup", function() {
            const filter = this.value.toLowerCase();
            const rows = document.querySelectorAll("#puntosTable tbody tr");
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? "" : "none";
            });
        });

        // Toggle formulario
        const toggleForm = document.getElementById("toggleForm");
        const formBody = document.getElementById("formBody");
        const formArrow = document.getElementById("formArrow");
        toggleForm.addEventListener("click", () => {
            if (formBody.style.display === "none") {
                formBody.style.display = "block";
                formArrow.classList.add("down");
            } else {
                formBody.style.display = "none";
                formArrow.classList.remove("down");
            }
        });

        // Checkbox para mismo horario
        function copyTime(srcClass, dstClasses) {
            const val = document.querySelector(`.${srcClass}`).value;
            dstClasses.forEach(cls => {
                document.querySelector(`.${cls}`).value = val;
            });
        }

        document.getElementById("sameStart").addEventListener("change", function() {
            const dias = ['lunes','martes','miercoles','jueves','viernes','sabado','domingo'];
            if (this.checked) {
                const val = document.querySelector('.inicio-lunes').value;
                dias.forEach(dia => {
                    document.querySelector(`.inicio-${dia}`).value = val;
                    document.querySelector(`.inicio-${dia}`).disabled = true;
                });
            } else {
                dias.forEach(dia => document.querySelector(`.inicio-${dia}`).disabled = false);
            }
        });

        document.getElementById("sameEnd").addEventListener("change", function() {
            const dias = ['lunes','martes','miercoles','jueves','viernes','sabado','domingo'];
            if (this.checked) {
                const val = document.querySelector('.fin-lunes').value;
                dias.forEach(dia => {
                    document.querySelector(`.fin-${dia}`).value = val;
                    document.querySelector(`.fin-${dia}`).disabled = true;
                });
            } else {
                dias.forEach(dia => document.querySelector(`.fin-${dia}`).disabled = false);
            }
        });

        // Auto expandir si hay un punto cargado
        {% if punto %}
        formBody.style.display = "block";
        formArrow.classList.add("down");
        {% endif %}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
