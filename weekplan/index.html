<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gesti√≥n de Turnos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
.ppam-logo {
  width: 20px;
  height: auto;
  transition: transform 0.25s ease, width 0.25s ease;
}

.ppam-logo:hover {
  transform: scale(0.95);
  opacity: 0.9;
}

  #gridSemana {
    min-width: 900px;
    overflow-x: auto;
  }

  .drop-turno {
   /* position: relative;  ¬°CLAVE! Permite que el bloque absoluto se posicione */
    /* Define una altura clara si se usa CSS Grid/Flex, ejemplo: */
    /* height: 40px; */ 
}
  .drop-turno.dragover {
    outline: 2px dashed #4f46e5;
  }
  .drop-turno:hover .marker {
  background-color: #eef2ff;
  border-color: #c7d2fe;
  color: #4338ca;
}

/* === Tooltip elegante para #tituloSemana === */
#tituloSemana {
  position: relative;
  cursor: help;
}

#tituloSemana::after {
  content: attr(data-tooltip);
  white-space: pre-line;
  position: absolute;
  bottom: -6.5em;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  color: #fff;
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease-in-out;
  min-width: 220px;
  text-align: left;
  z-index: 9999;
}

#tituloSemana:hover::after {
  opacity: 1;
}
/* üîπ Dise√±o responsive del men√∫ principal */
@media (max-width: 768px) {
  nav.flex {
    flex-wrap: wrap; /* Permite que los botones bajen a otra l√≠nea */
    justify-content: center;
    gap: 0.5rem;
  }

  nav.flex button {
    flex: 1 1 auto;           /* que se adapten */
    min-width: 45%;           /* 2 botones por fila */
    text-align: center;
  }

  /* Espacio debajo del t√≠tulo */
  #tituloSemana {
    font-size: 1rem;
    text-align: center;
    margin-top: 0.5rem;
  }
}

/* ===== Mantener el header alineado en una sola l√≠nea ===== */
header {
  white-space: nowrap;
}

header h1 {
  display: inline-block;
  margin: 0 4px;
}

@media (max-width: 600px) {
  header {
    flex-wrap: nowrap;
    gap: 0.5rem;
  }

  header h1 {
    font-size: 0.9rem;
    white-space: nowrap;
  }

  header .ppam-logo {
    width: 40px; /* m√°s chico en m√≥vil */
  }

  /* Evitar que ‚ÄúPPAM - 2025‚Äù salte de l√≠nea */
  header h1:nth-of-type(2) {
    display: inline-block;
    margin-left: auto;
  }
}
/* =========================== Lista Usuarios + Calendario: Un poco mas responsive ================= */
/* ===== Scroll horizontal m√°s usable en Planificar Turnos ===== */
#tab-planificar {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch; /* scroll fluido en iPhone */
}

#planificador_turnos {
  display: flex;
  flex-wrap: nowrap;
  gap: 1rem;
  min-width: 900px; /* asegura ancho completo en escritorio */
}

@media (max-width: 768px) {
  #planificador_turnos {
    flex-direction: column; /* en m√≥vil, apila usuarios y calendario */
    min-width: 100%;        /* ocupa todo el ancho */
  }

  #planificador_turnos > div {
    width: 100% !important;
    overflow-x: auto;        /* scroll horizontal interno solo si necesario */
  }
  
  #planificador_turnos, header {
  transition: all 0.25s ease;
}

  #gridSemana {
    min-width: 700px; /* ancho interno manejable */
  }
}
/* ================================ BOTON ASIGNAR AUTO ======================= */
.btn-3d {
  position: relative;
  background: linear-gradient(to bottom, #ffffff, #dbeafe);
  color: #2563eb;
  border: 1px solid #93c5fd;
  border-radius: 9999px; /* redondo */
  font-weight: bold;
  padding: 0.5rem 1rem;
  box-shadow: 0 4px 0 #93c5fd;
  transition: all 0.15s ease;
}

.btn-3d:hover {
  background: linear-gradient(to bottom, #f0f9ff, #dbeafe);
  transform: translateY(-1px);
  box-shadow: 0 5px 0 #93c5fd, 0 6px 8px rgba(0, 0, 0, 0.15);
}

.btn-3d:active {
  transform: translateY(3px);
  box-shadow: 0 1px 0 #93c5fd;
  background: linear-gradient(to bottom, #dbeafe, #bfdbfe);
}

.btn-3d:hover::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 9999px;
  background: radial-gradient(circle at top left, rgba(255,255,255,0.6), transparent 60%);
  opacity: 0.8;
  pointer-events: none;
  animation: shimmer 1s ease-in-out infinite alternate;
}

@keyframes shimmer {
  from { transform: translate(0,0); opacity: 0.6; }
  to { transform: translate(5px, 5px); opacity: 0.9; }
}

/* ======================= FIN =============================================== */

@media (max-width: 768px) {
  #gridSemana {
    min-width: 700px; /* un poco m√°s compacto */
  }

  #planificador_turnos {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* scroll fluido en iOS */
  }
}

@media (max-width: 600px) {
  header h1 {
    font-size: 0.9rem;
    text-align: center;
  }

  .tab-btn {
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
  }

  main {
    padding: 0.8rem;
  }
}


@media (max-width: 600px) {
  .ppam-logo {
    width: 120px;
  }
}
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Topbar -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
     <a href="https://metropoliplan.appwebterritorios.com" id="topbar-back" class="topbar-back" title="Volver atr√°s">‚üµ Inicio</a><h1 class="text-lg font-semibold">Gesti√≥n de Turnos&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h1><h1>&nbsp;PPAM - 2025&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</h1>
	<a href="https://metropoliplan.appwebterritorios.com"><img src="../imagenes/logo_ppam.png" alt="PPAM logo" class="ppam-logo"></a>
  </header>

  <!-- Tabs -->
  <nav class="flex  bg-gray-200 p-2">
    <button onclick="mostrarTab('turnos')" class="tab-btn px-4 py-2 bg-white rounded mr-2">Turnos</button>
    <button onclick="mostrarTab('puntos')" class="tab-btn px-4 py-2 bg-white rounded mr-2">Puntos</button>
    <button onclick="mostrarTab('solicitudes')" class="tab-btn px-4 py-2 bg-white rounded">Solicitudes</button> &nbsp;<!-- <div class="flex-grow"></div> -->
	 <button onclick="mostrarTab('planificar')" class="tab-btn px-4 py-2 bg-white rounded ">Planificar Turnos</button>&nbsp;
	 <button onclick="enviarNotificaciones()" class="tab-btn px-4 py-2 bg-amber-500 text-white rounded ">Enviar notificaciones</button>&nbsp;
	 <button onclick="mostrarTab('entorno')" class="tab-btn px-4 py-2 bg-emerald-500 rounded">Ver entorno</button>&nbsp;
	 <button onclick="verEstadisticas()" class="tab-btn px-4 py-2 bg-red-500 text-white rounded ">Estad&iacute;sticas</button>&nbsp;
	 <!-- Bot√≥n para abrir calendario -->
     <button id="abrirCalendario" class="bg-blue-600 text-white px-4 py-2 rounded">üìÖ Crear Turno</button>&nbsp;
	 <button onclick="mostrarTab('pipeline')" class="tab-btn px-4 py-2 bg-purple-500 text-white rounded">Flujo Bot</button>&nbsp;
	 <button onclick="mostrarTab('botlog')"  class="tab-btn px-4 py-2 bg-indigo-500 text-white rounded">Log del Bot</button>
  </nav>



  <!-- Contenido -->
  <main class="p-4">
   <!-- CALENDARIO -->
  <div id="crear_turno_calendario" class="calendar-wrapper hidden"></div>

  
   <!-- TAB PLANIFICAR -->
    <div id="tab-planificar" class="tab-content hidden">
	<div id="planificador_turnos" class="hidden"></div>
      <div class="flex justify-between items-center mb-4">
        <!-- <h2 class="text-xl font-bold">Planificar Turnos</h2> -->
        <!-- <button id="crearTurno" class="bg-blue-500 text-white px-3 py-1 rounded">+ Crear</button> -->
		
		
		<!-- Bot√≥n Asignar -->
        <!-- <button id="asignarTurno" class="bg-white text-blue-600 px-3 py-1 rounded-full font-bold">Asignar AUTO</button> -->
		<button id="asignarTurno" class="btn-3d  mx-2 shadow-lg">Asignar AUTO</button>
		
		<button onclick="mostrarTab('pipeline')" class="bg-emerald-600 text-white px-3 py-1 rounded">Ver flujo del Bot</button>
  
   </div>
     </div>	  
  
    <!-- TAB TURNOS -->
    <div id="tab-turnos" class="tab-content">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Turnos</h2>
        <!-- <button id="crearTurno" class="bg-blue-500 text-white px-3 py-1 rounded">+ Crear</button> -->
		
		
		<!-- Bot√≥n Crear -->
        <button id="crearTurno" class="bg-white text-blue-600 px-3 py-1 rounded-full font-bold">+</button>

<!-- Modal -->
<div id="modalCrear" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-lg font-bold mb-4">Crear Turno</h2>
    <form id="formCrear" class="flex flex-col gap-3">
      <input type="date" name="fecha" class="border p-2 rounded" required>
      <div class="flex gap-2">
        <input type="time" name="hora_inicio" class="border p-2 rounded w-1/2" required>
        <input type="time" name="hora_fin" class="border p-2 rounded w-1/2" required>
      </div>
      <select name="punto_id" id="selectPunto" class="border p-2 rounded" required></select>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelarModal" class="px-3 py-1 bg-gray-300 rounded">Cancelar</button>
        <button type="submit" class="px-3 py-1 bg-blue-600 text-white rounded">Guardar</button>
      </div>
    </form>
  </div>
</div> 

		
		
      </div>
      <div id="turnosList" class="grid gap-4"></div>
    </div>

    <!-- TAB PUNTOS -->
    <div id="tab-puntos" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Puntos de Predicaci√≥n</h2>
      <div id="puntosList" class="grid gap-4"></div>
    </div>

    <!-- TAB SOLICITUDES -->
    <div id="tab-solicitudes" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">Solicitudes</h2>

      <!-- Formulario -->
      <form id="formSolicitud" class="bg-white p-4 rounded shadow mb-4 flex flex-col gap-2 max-w-md">
       <label for="turnoSelect">Selecciona punto:</label>
<select id="turnoSelect" name="punto_id" class="border rounded w-full p-1"></select>
	  
        <label>
          Rol:
          <select id="rolSelect" name="rol" class="border rounded w-full p-1">
            <option value="publicador">Publicador</option>
            <option value="capitan">Capit√°n</option>
          </select>
        </label>
        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded">Postularse</button>
      </form>

      <!-- Lista -->
      <div id="solicitudesList" class="grid gap-4"></div>
    </div>
	
	<!-- TAB ENTORNO -->
<div id="tab-entorno" class="tab-content hidden">
  <h2 class="text-xl font-bold mb-4">Configuraciones del Entorno</h2>
  <div id="configList" class="grid gap-4"></div>
</div>

<!-- TAB PIPELINE BOT -->
<div id="tab-pipeline" class="tab-content hidden">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Flujo del Bot Asignador</h2>
    <div class="flex gap-2">
      <button onclick="actualizarPipeline()" class="bg-blue-500 text-white px-3 py-1 rounded">Actualizar</button>
      <button onclick="abrirPipelineEnNuevaPesta√±a()" class="bg-gray-600 text-white px-3 py-1 rounded">Abrir en nueva pesta√±a</button>
    </div>
  </div>

  <div id="pipelineOutput"
       class="bg-black text-green-300 font-mono text-xs sm:text-sm p-3 rounded overflow-y-auto h-[500px] whitespace-pre-wrap shadow-inner border border-gray-700">
    (sin datos a√∫n)
  </div>
</div>
<!-- TAB LOG DEL BOT -->
<div id="tab-botlog" class="tab-content hidden">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">Mensajes del Bot (JSON)</h2>
    <div class="flex gap-2">
      <button onclick="actualizarBotLog()" class="bg-blue-500 text-white px-3 py-1 rounded">Actualizar</button>
      <button onclick="abrirBotLogNuevaPesta√±a()" class="bg-gray-600 text-white px-3 py-1 rounded">Abrir en nueva pesta√±a</button>
    </div>
  </div>

  <pre id="botLogOutput"
       class="bg-gray-900 text-green-300 text-xs sm:text-sm p-3 rounded overflow-y-auto h-[500px] whitespace-pre-wrap shadow-inner border border-gray-700">
    (sin datos a√∫n)
  </pre>
</div>
	
  </main>

  <script>
    // ------ FUNCIONES GENERALES ------
	// ------ LIstener -----------------
	// LISTENER ROBUSTO PARA INYECTAR EL CALENDARIO ADMIN
document.getElementById('abrirCalendario').addEventListener('click', async () => {
  const div = document.getElementById('crear_turno_calendario');
 // div.classList.remove("hidden");
  try {
    // 1) Si a√∫n no cargamos el HTML, hacerlo
    if (div.innerHTML.trim() === '') {
      // fetch del fragmento HTML (sin <html> ni <head>)
      const html = await fetch('calendario_admin_inyectar.php').then(r => {
        if (!r.ok) throw new Error('No se pudo cargar calendario_admin_inyectar.php ('+r.status+')');
        return r.text();
      });
      div.innerHTML = html;
    }
	
	// 2) inyectar CSS (si no est√°)
    if (!document.querySelector('link[href*="app_turnos.css"]')) {
      const css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = '../css/app_turnos.css';
      document.head.appendChild(css);
      // opcional: esperar brevemente a que lo procese el navegador
      await new Promise(r => setTimeout(r, 60));
    }


    // 3) inyectar CSS (si no est√°)
    if (!document.querySelector('link[href*="app_turnos_admin.css"]')) {
      const css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = '../css/app_turnos_admin.css';
      document.head.appendChild(css);
      // opcional: esperar brevemente a que lo procese el navegador
      await new Promise(r => setTimeout(r, 60));
    }

    // 4) cargar / ejecutar el script admin (si no est√°)
    async function ensureAdminScript() {
      if (window.AppTurnosAdmin && typeof window.AppTurnosAdmin.initCalendar === 'function') {
        return window.AppTurnosAdmin;
      }
      // crear y a√±adir <script>
      return new Promise((resolve, reject) => {
        const existing = Array.from(document.scripts).find(s => s.src && s.src.indexOf('app_turnos_admin.js') !== -1);
        if (existing) {
          // ya est√° en el DOM pero quiz√° no haya terminado de inicializar
          existing.addEventListener('load', () => {
            resolve(window.AppTurnosAdmin);
          });
          // si ya carg√≥, resolver inmediatamente
          if (existing.readyState === 'complete' || existing.readyState === 'loaded') {
            setTimeout(() => resolve(window.AppTurnosAdmin), 50);
          }
          return;
        }
        const script = document.createElement('script');
        script.src = '../js/app_turnos_admin.js';
        script.async = true;
        script.onload = () => {
          // peque√±o retraso para que el IIFE se ejecute y defina AppTurnosAdmin
          setTimeout(() => resolve(window.AppTurnosAdmin), 60);
        };
        script.onerror = (e) => reject(new Error('No se pudo cargar app_turnos_admin.js'));
        document.body.appendChild(script);
      });
    }

    const AppAdmin = await ensureAdminScript();

    // 5) inicializar (si existe) ‚Äî con protecciones
    if (AppAdmin && typeof AppAdmin.initCalendar === 'function') {
      try {
        AppAdmin.initCalendar();
      } catch (errInit) {
        console.error('Error inicializando AppTurnosAdmin.initCalendar():', errInit);
      }
    } else {
      console.warn('AppTurnosAdmin no est√° disponible despu√©s de cargar script.');
    }

    // 6) mostrar el panel con animaci√≥n/visibilidad
    // preferimos togglear una clase visible en vez de depender solo de "hidden"
    div.classList.toggle('hidden');            // mantiene compatibilidad
    div.classList.toggle('visible');           // si a√±adiste estilos .visible, se aplica

    // 7) foco o scroll para que el usuario lo vea (√∫til si el panel queda abajo)
    setTimeout(() => {
      if (!div.classList.contains('hidden')) {
        div.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 120);

  } catch (err) {
    console.error('Error al intentar abrir calendario:', err);
    alert('Error cargando el calendario: ' + (err.message || err));
  }
});



// cuando se muestra el tab de entorno, cargar las configuraciones	
	function mostrarTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.add("hidden"));
  const activeTab = document.getElementById("tab-" + tab);
  activeTab.classList.remove("hidden");

  // üîπ Desoculta elementos internos del tab
  activeTab.querySelectorAll(".hidden").forEach(el => el.classList.remove("hidden"));

  if (tab === "entorno") {
    cargarConfiguraciones();
    }
	
	/* if (tab === "turnos" || tab === "puntos" || tab === "solicitudes") {
  
      } */
	  
  if (tab === "planificar") {
    PlanificadorInteractivo.init();
    }
	
	if (tab === "turnos") {
    document.getElementById("modalCrear").classList.add("hidden");
    }
	
	
}


    // ------ TURNOS ------
    async function cargarTurnos() {
      const res = await fetch("../api/turnos.php?accion=listar");
      const turnos = await res.json();
      const list = document.getElementById("turnosList");
      const select = document.getElementById("turnoSelect"); // usado en solicitudes
      list.innerHTML = "";
      select.innerHTML = "";

      turnos.forEach(t => {
        // Card
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4 flex flex-col sm:flex-row justify-between";
        card.innerHTML = `
          <div>
            <h3 class="text-lg font-semibold">Punto ${t.punto}</h3>
            <p class="text-gray-600">${t.fecha} ${t.hora_inicio} - ${t.hora_fin}</p>
            <span class="text-sm text-${t.estado === 'planificado' ? 'green' : 'yellow'}-600">${t.estado}</span>
          </div>
          <div class="flex items-center gap-2 mt-2 sm:mt-0">
           <button onclick="editarTurno(${t.id}, '${t.fecha}', '${t.hora_inicio}', '${t.hora_fin}', ${t.punto_id})" 
      class="bg-blue-500 text-white px-3 py-1 rounded">Editar</button>
            <button onclick="cancelarTurno(${t.id})" class="bg-red-500 text-white px-3 py-1 rounded">Cancelar</button>
			<button onclick="asignarTurno(${t.id})" class="bg-emerald-500 text-white px-3 py-1 rounded">Abrir</button>
			<button onclick="planificarTurno(${t.id})" class="bg-amber-500 text-white px-3 py-1 rounded">Planificar</button>
          </div>
        `;
        list.appendChild(card);

        // Opci√≥n en select de solicitudes
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = `Turno ${t.fecha} ${t.hora_inicio} - ${t.hora_fin}`;
        select.appendChild(opt);
      });
    }
// Listener para bot√≥n "Asignar AUTO" ...
// Incorporado el 28/10/2025 ...
	document.getElementById("asignarTurno").addEventListener("click", async () => {
  if (!confirm("¬øEjecutar asignaci√≥n autom√°tica de turnos?")) return;

  try {
    const res = await fetch("../api/turnos.php?accion=asignar_auto", {
      method: "POST"
    });

    if (!res.ok) throw new Error(`Error HTTP ${res.status}`);

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Error desconocido");

    alert(`‚úÖ Bot ejecutado: ${data.procesados} turnos procesados.`);

    // Actualizar lista y pipeline
    await cargarTurnos();
    actualizarPipeline();

  } catch (err) {
    console.error("Error en Asignar AUTO:", err);
    alert("‚ùå " + err.message);
  }
});

// Edici√≥n de turnos...

function editarTurno(id, fecha, hora_inicio, hora_fin, punto_id) {
  const modal = document.getElementById("modalCrear");
  const form  = document.getElementById("formCrear");

  // precargar valores
  form.fecha.value       = fecha;
  form.hora_inicio.value = hora_inicio;
  form.hora_fin.value    = hora_fin;
  form.punto_id.value    = punto_id;

  // cambiar comportamiento del submit
  form.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(form);

    const res = await fetch(`../api/turnos.php?accion=editar&id=${id}`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();

    if (data.ok) {
      alert("Turno actualizado");
      modal.classList.add("hidden");
      cargarTurnos();
    } else {
      alert("Error: " + data.error);
    }
  };

  modal.classList.remove("hidden");
}


async function cancelarTurno(id) {
      await fetch("../api/turnos.php?accion=cancelar", {
        method: "POST",
        body: new URLSearchParams({ turno_id: id })
      });
      cargarTurnos();
	  cargarSolicitudes();
    }
	
async function asignarTurno(id) {
      await fetch("../api/turnos.php?accion=abrir", {
        method: "POST",
        body: new URLSearchParams({ turno_id: id })
      });
      cargarTurnos();
	  cargarSolicitudes();
    }	
	
	
	async function planificarTurno(id) {
  try {
    const res = await fetch("../api/turnos.php?accion=planificar", {
      method: "POST",
      body: new URLSearchParams({ turno_id: id }),
    });

    // 1Ô∏è‚É£ Verificar si hubo error HTTP
    if (!res.ok) {
      throw new Error(`Error HTTP ${res.status}: ${res.statusText}`);
    }

    // Intentar leer JSON (protegido contra errores HTML)
    let data;
    try {
      data = await res.json();
    } catch (e) {
      const text = await res.text();
      console.error("Respuesta no-JSON:", text);
      alert("El servidor devolvi√≥ una respuesta inesperada (no JSON).");
      return;
    }

    // Verificar si el backend devolvi√≥ error interno
    if (data.error) {
      alert("‚ö†Ô∏è " + data.error);
      console.error("Error del backend:", data.error);
      return;
    }

    // √âxito: mostrar aviso y abrir pipeline si existe
    alert("‚úÖ Turno planificado exitosamente: " + data.estado);
	// Opcional: Mostrar el log del Bot, un chiche...
	// mostrarTab("botlog");
    // actualizarBotLog();

// Si el backend devolvi√≥ texto del pipeline, actualizar el tab
if (data.pipeline_text) {
  const tab = document.getElementById("pipelineOutput");
  tab.innerText = data.pipeline_text;
  mostrarTab("pipeline");
} else {
  actualizarPipeline();
  mostrarTab("pipeline");
}
  //  if (data.pipeline_url) {
  //    window.open(data.pipeline_url, "_blank");
  //   }

    // 5Ô∏è‚É£ Refrescar datos
    await Promise.all([cargarTurnos(), cargarSolicitudes()]);

  } catch (error) {
    // 6Ô∏è‚É£ Cualquier error de red u otro
    console.error("Error en la operaci√≥n:", error);
    alert("‚ùå Hubo un problema con la operaci√≥n. Intente nuevamente.");
  }
}

// ---------- PIPELINE BOT ----------
let lastPipelineText = "";

async function actualizarPipeline() {
  const res = await fetch("../tmp/bot_log.json?ts=" + Date.now());
  if (!res.ok) {
    document.getElementById("pipelineOutput").innerText = "Error al cargar el pipeline.";
    return;
  }
  const data = await res.json();

  // Mostrar el texto si lo trae directo
  if (data.pipeline_text) {
    lastPipelineText = data.pipeline_text;
    document.getElementById("pipelineOutput").innerText = data.pipeline_text;
  } 
  // O bien si hay un archivo disponible
  else if (data.pipeline_url) {
    try {
      const txtRes = await fetch(".." + data.pipeline_url);
      const txt = await txtRes.text();
      lastPipelineText = txt;
      document.getElementById("pipelineOutput").innerText = txt;
    } catch (e) {
      document.getElementById("pipelineOutput").innerText = "Error leyendo archivo del pipeline.";
    }
  } 
  else {
    document.getElementById("pipelineOutput").innerText = "No hay datos de pipeline disponibles a√∫n.";
  }
}

// Mostrar el pipeline m√°s reciente en una pesta√±a nueva (opcional)
function abrirPipelineEnNuevaPesta√±a() {
  if (!lastPipelineText) {
    alert("No hay pipeline cargado a√∫n.");
    return;
  }
  const w = window.open();
  w.document.write('<pre style="background:#000;color:#0f0;font-family:monospace;padding:1em;">' + 
                   lastPipelineText.replace(/[<>]/g, c => c === '<' ? '&lt;' : '&gt;') +
                   '</pre>');
  w.document.title = "Pipeline Bot Asignador";
}

// ------ LOG DEL BOT (JSON) ------
async function actualizarBotLog() {
  try {
    const res = await fetch("../tmp/bot_log.json?cache=" + Date.now());
    if (!res.ok) throw new Error(`Error al leer bot_log.json (${res.status})`);
    const jsonText = await res.text();

    try {
      // Intenta formatear bonito
      const data = JSON.parse(jsonText);
      document.getElementById("botLogOutput").innerHTML = syntaxHighlight(data);
    } catch {
      document.getElementById("botLogOutput").innerText = jsonText;
    }
  } catch (err) {
    document.getElementById("botLogOutput").innerText = "Error al cargar log: " + err.message;
  }
}

function abrirBotLogNuevaPesta√±a() {
  window.open("../tmp/bot_log.json", "_blank");
}

// ------ Formateador de JSON con colores ------
function syntaxHighlight(json) {
  if (typeof json != "string") json = JSON.stringify(json, undefined, 2);
  json = json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|\b[\d.]+\b)/g, function (match) {
    let cls = "text-green-400";
    if (/^"/.test(match)) {
      if (/:$/.test(match)) cls = "text-blue-300 font-semibold";
      else cls = "text-yellow-300";
    } else if (/true|false/.test(match)) cls = "text-purple-300";
    else if (/null/.test(match)) cls = "text-gray-400 italic";
    return `<span class="${cls}">${match}</span>`;
  });
}

// Estad√≠sticas...

function verEstadisticas() {    
  // URL del sitio de estadisticas...
  const urlEstadisticas = 'https://metropoliplan.appwebterritorios.com/tablero_admin.php';  
  // Realiza la redirecci√≥n
  window.location.href = urlEstadisticas;
}
async function enviarNotificaciones() {
     // await fetch("../envios/cron_notificaciones.php", {
     //  });
	  
	 
  try {
    const res = await fetch("../envios/cron_notificaciones.php", {
      method: "POST",
      // body: new URLSearchParams({ turno_id: id })
    });

    // 1. Verificar si la respuesta es OK (status 200-299)
    if (!res.ok) {
      throw new Error(`Error en la petici√≥n: ${res.status}`);
    }

    const data = await res.json();

    // 2. Comprobar si el JSON contiene un mensaje de error del backend
    if (data.error) {
      alert(data.error); // Muestra el mensaje de error del backend
      console.error('Error del backend:', data.error);
    } else {
      // 3. Si no hay error, el proceso fue exitoso
      alert(data.msj);
  
      console.log('Mensaje del backend:', data.msj);
  
      cargarTurnos(); // Recarga la lista de turnos
    }
  } catch (error) {
    // 4. Capturar errores de red o errores de parseo de JSON
    // alert("Hubo un problema con la operaci√≥n. Intente nuevamente.");
    console.error('Error en la operaci√≥n:', error);
  }
  
   cargarTurnos();
   cargarSolicitudes();
} 

    document.getElementById("crearTurno").addEventListener("click", async () => {
      const res = await fetch("../api/turnos.php?accion=crear", { method: "POST" });
      if (res.ok) cargarTurnos();
    });

    // ------ PUNTOS ------
   async function cargarPuntos() {
      const res = await fetch("../api/puntos.php?accion=listar");
      const puntos = await res.json();
      const list = document.getElementById("puntosList");
      list.innerHTML = "";

      puntos.forEach(p => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4";
        card.innerHTML = `
          <h3 class="text-lg font-semibold">${p.nombre}</h3>
          <p class="text-gray-600">${p.lugar_encuentro || ""}</p>
        `;
        list.appendChild(card);
      });
    }

document.getElementById("crearTurno").addEventListener("click", () => {
  document.getElementById("modalCrear").classList.remove("hidden");
  cargarPuntos();
});

document.getElementById("cancelarModal").addEventListener("click", () => {
  document.getElementById("modalCrear").classList.add("hidden");
});

document.getElementById("formCrear").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const res = await fetch("../api/turnos.php?accion=crear", {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  if (data.ok) {
    alert("Turno creado");
    document.getElementById("modalCrear").classList.add("hidden");
    cargarTurnos();
  } else {
    alert("Error: " + data.error);
  }
});


    // ------ SOLICITUDES ------
    async function cargarSolicitudes() {
      const res = await fetch("../api/solicitudes.php?accion=listar");
      const solicitudes = await res.json();
      const list = document.getElementById("solicitudesList");
      list.innerHTML = "";

      solicitudes.forEach(s => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4 flex justify-between";
        card.innerHTML = `
          <div>
            <h3 class="font-semibold">Punto: ${s.punto}</h3>
			<h3 class="font-semibold">Turno: ${s.fecha}</h3>
			<h3 class="font-semibold">Publicador: ${s.usuario}</h3>
            <p class="text-gray-600">Rol: ${s.rol}</p>
            <p class="text-gray-500">Estado: ${s.estado}</p>
          </div>
          <button onclick="eliminarSolicitud(${s.id})" class="bg-red-500 text-white px-3 py-1 rounded">Cancelar</button>
        `;
        list.appendChild(card);
      });
    }

    document.getElementById("formSolicitud").addEventListener("submit", async e => {
      e.preventDefault();
      const data = new FormData(e.target);
      await fetch("../api/solicitudes.php?accion=crear", { method: "POST", body: data });
      cargarSolicitudes();
    });

    async function eliminarSolicitud(id) {
      await fetch("../api/solicitudes.php?accion=eliminar", {
        method: "POST",
        body: new URLSearchParams({ id })
      });
      cargarSolicitudes();
    }
	
	async function cargarSelectPuntos() {
  const res = await fetch("../api/puntos.php?accion=listar");
  const puntos = await res.json();

  const select = document.getElementById("selectPunto");
  select.innerHTML = "<option value=''>-- Selecciona un punto --</option>";

  puntos.forEach(p => {
    const option = document.createElement("option");
    option.value = p.id;        // üëà este es el ID que se guarda en turnos.punto_id
    option.textContent = p.nombre; // üëà lo que ve el usuario
    select.appendChild(option);
  });
}

// ------ CONFIGURACIONES DEL ENTORNO (editable) ------
async function cargarConfiguraciones() {
  try {
    const res = await fetch("../api/load_config_json.php");
    const data = await res.json();

    const list = document.getElementById("configList");
    list.innerHTML = "";

    if (!data.ok) {
      list.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded">Error: ${data.error}</div>`;
      return;
    }

    const configuraciones = data.configuraciones;

    configuraciones.forEach(cfg => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-lg shadow p-4 border border-gray-200";
      card.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-lg font-semibold">${cfg.seccion} / ${cfg.clave}</h3>
          <span class="text-sm bg-gray-100 px-2 py-1 rounded">${cfg.tipo}</span>
        </div>
        <input id="valor-${cfg.id}" type="text" value="${cfg.valor}" 
               class="border rounded w-full p-2 text-gray-700" />
        <div class="flex justify-end mt-2">
          <button onclick="guardarConfiguracion(${cfg.id})" 
                  class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
            üíæ Guardar
          </button>
        </div>
      `;
      list.appendChild(card);
    });
  } catch (error) {
    console.error("Error cargando configuraciones:", error);
    const list = document.getElementById("configList");
    list.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded">Error al obtener configuraciones</div>`;
  }
}

// Guarda un valor editado
async function guardarConfiguracion(id) {
  const valor = document.getElementById(`valor-${id}`).value;

  try {
    const res = await fetch("../api/load_config.php", {
      method: "POST",
      body: new URLSearchParams({ id, valor })
    });
    const data = await res.json();

    if (data.ok) {
      alert("Configuraci√≥n actualizada correctamente.");
    } else {
      alert("Error: " + data.error);
    }
  } catch (err) {
    alert("Error de red o servidor.");
    console.error(err);
  }
}


 // Inicializaci√≥n

    cargarSelectPuntos();  
    cargarTurnos();
    cargarPuntos();
    cargarSolicitudes();
	
	
	
  </script>
  <script src="../js/planificador_interactivo.js"></script>

</body>
</html>
